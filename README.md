# Распределенный вычислитель арифметических выражений

<details><summary><b>Задание</b></summary>

Пользователь хочет считать арифметические выражения.
Он вводит строку `2 + 2 * 2` и хочет получить в ответ `6`.
Но наши операции сложения и умножения (также деления и вычитания) выполняются **"очень-очень" долго**.
Поэтому вариант, при котором пользователь делает http-запрос и получает в качетсве ответа результат, **невозможна**.
Более того: вычисление каждой такой операции в нашей **"альтернативной реальности"** занимает **"гигантские"** вычислительные мощности.
Соответственно, каждое действие мы должны уметь выполнять отдельно и масштабировать эту систему можем добавлением вычислительных мощностей в нашу систему в виде новых "**машин**".
Поэтому пользователь, присылая выражение, получает в ответ идентификатор выражения и может с какой-то периодичностью уточнять у сервера "не посчиталость ли выражение"?
Если выражение наконец будет вычислено - то он получит результат.
Помните, что некоторые части арфиметического выражения можно вычислять **параллельно**.

## Back-end часть

### Состоит из 2 элементов:

- Сервер, который принимает арифметическое выражение, переводит его в набор последовательных задач и обеспечивает порядок их выполнения. Далее будем называть его оркестратором.
- Вычислитель, который может получить от оркестратора задачу, выполнить его и вернуть серверу результат. Далее будем называть его агентом.

### Оркестратор
Сервер, который имеет следующие endpoint-ы:

- Добавление вычисления арифметического выражения.
- Получение значения выражения по его идентификатору.
- Получение списка всех выражений.
- Получение задачи для выполнения.
- Приём результата обработки данных.


### Агент
Демон, который получает выражение для вычисления с сервера, вычисляет его и отправляет на сервер результат выражения. При старте демон запускает несколько горутин, каждая из которых выступает в роли независимого вычислителя. Количество горутин регулируется переменной среды.
</details>

## Инструкция к запуску:
1. Склонировать проект или скачать `git clone https://github.com/katenester/Distributed_computing`
2. Установить все зависимости из go.mod `go mod download` `go mod tidy`
3. Переходим в папку с проектом на компьютере. `cd Distributed_computing`
4. Открываем два терминала (win+R->cmd). В первом окне ввести ` go run cmd/orchestrator/main.go` . Во втором окне ввести `go run cmd/agent/main.go `. Должны запустится процессы и идти логи. Для отключения процессов Ctrl+s

## Тестирование:
<details><summary><b>Примеры использования с помощью curl</b></summary>
Удобнее всего тестировать работу из Postman(пункт ниже), но также приведены описания примеры запросов через curl

***Добавить выражения (POST)***

```bash
curl --location 'http://localhost:8080/api/v1/calculate' \
--header 'Content-Type: application/json' \
--data '{
      "expression": "2.5+2*(-2)"
}'
```
***Получить список выражений (GET)***
```bash
curl --location 'http://localhost:8080/api/v1/expressions'
```
***Получить выражение по его id (GET)***
```bash
curl --location 'http://localhost:8080/api/v1/expressions/1717341632116157400'
```
***Получить задачи для выполнения(GET)***
```bash
curl --location 'http://localhost:8080/internal/task'
```
***Прием результата обработки данных(POST)***
```bash
curl --location 'http://localhost:8080/internal/task' \
--header 'Content-Type: application/json' \
--data '{
    "id": 1717341915811790400,
    "result": -8
}'
```
</details>

<details><summary><b>Postman</b></summary>

## Инструкция к запуску:
1. Скачать программу Postman https://www.postman.com/downloads/  
2. Скачать файл со всеми тестами, который покрывает разные сценарии: всё хорошо, ошибки. Импортировать его в Postman.

**Файл: [Postman](https://github.com/katenester/Distributed_computing/blob/main/docs/Testing%20arithmetic%20expressions.postman_collection.json)**

Запросы тестировались через Postman

***Добавить выражения (POST)***

`http://localhost:8080/api/v1/calculate` 
```json
{
      "expression": "2.5+2*(-2)"
}
```
![](https://github.com/katenester/Distributed_computing/blob/main/docs/Postman%20image/Test1.png)

***Получить список выражений (GET)*** 

`http://localhost:8080/api/v1/expressions`

![](https://github.com/katenester/Distributed_computing/blob/main/docs/Postman%20image/Test2.png)

***Получить выражение по его id***

`http://localhost:8080/api/v1/expressions/1717341632116157400` P/S/ id генерируется на сервере и возвращается в методе Добавить выражения (POST)

![](https://github.com/katenester/Distributed_computing/blob/main/docs/Postman%20image/Test3.png)

***Получить задачи для выполнения(GET)*** 

`http://localhost:8080/internal/task`  

![](https://github.com/katenester/Distributed_computing/blob/main/docs/Postman%20image/Test4.png)

***Прием результата обработки данных(POST)*** 

`http://localhost:8080/internal/task` 
```json
{
    "id": 1717341915811790400,
    "result": -8
}
```
либо если ошибка деления на 0:
```json
{
    "id": 1717337438507076300,
    "result": 0,
    "error":"Деление на ноль"
}
```
id задачи можно было получить из метода GET

![](https://github.com/katenester/Distributed_computing/blob/main/docs/Postman%20image/Test5.png)

**Результаты вычислений**
![](https://github.com/katenester/Distributed_computing/blob/main/docs/Postman%20image/Test2-2.png)
</details>

## Схема работы Backend
<a name="схема-работы-backend"></a>
![Схема Backend](https://github.com/katenester/Distributed_computing/blob/main/docs/Chema.png)
P.S.
Сервер принимает выражение, проверяет его на корректность, переводит в обратную польскую запись, составляет задачи для агента. Также он отдаёт все выражения или выражение по его id, которое выдается клиенту после добавления.
Демон запускает агентов в горутинах. Агент все время приходит к оркестратору с запросом "дай задачку поработать" (в ручку GET internal/task для получения задач). Оркестратор отдаёт задачу.
Агент производит вычисление и в ручку оркестратора (POST internal/task для приёма результатов обработки данных) отдаёт результат.
